/* autogenerated by Processing revision 1293 on 2023-10-15 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;
import processing.serial.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class Main extends PApplet {








Serial myPort; 

PImage img;

float yPos, prePosx, temp, tempRaw, preHeat, currentAltitude, currentAltitudeRaw, formerAltitude, climbR, preAlt, press, prePress, hum, humRaw, prehum, allign;

String FStroke;
String input = "0";

int[] sensorData;

int xPos, backgroundReset = 1;
int intro, alpha = 0;
int intStroke;
long interval, interval2 = 0;


public void setup() {
    /* size commented out by preprocessor */;
    
    myPort = new Serial(this, "COM16", 115200); //COM port of your board
    myPort.bufferUntil('\n'); //Checks for first line break to initiate 
    myPort.write('r'); //Sends a character to wake up BMP280
    
    background(0); //Set Start page
    textSize(100);
    textAlign(CENTER);
    fill(0xFFFFFFFF);
    text("Flight Control", 850, 100);
    textSize(40);
    text("press enter to continue", 850, 550);
    text("Sea-Level pressure Today:", 850, 380);
    rectMode(CENTER);
    
    img = loadImage("Reload.png");
    
    delay(10);
}




public void draw() {
    
    FStroke = input.substring(Math.max(0, input.length() - 4)); //Caps String at 4 characters
    
    try{ 
        intStroke = Integer.valueOf(FStroke);
    } 
    catch(NumberFormatException ex) {
        ex.printStackTrace();
    }
    
    if (intro != 1) { //Intro loop for Sea-Level text
        stroke(255, 255, 255);
        fill(0x000000);
        rect(850, 450, 150, 60);
        textAlign(CENTER);
        fill(255, 255, 255);
        textSize(60);
        text(FStroke, 850, 470);
        delay(10);
        
        formerAltitude = currentAltitudeRaw;
    }
    
    if (keyCode == BACKSPACE && intro != 1) { //Reset Sea-Level text
        input = "0";
    }
    
    if (keyCode == ENTER && intro != 1) { //Main programm startup
        background(0);
        delay(10);
        intro = 1;
    }
    
    
    ////////////////////////////////////////////////
    //  Main Program                  //
    ////////////////////////////////////////////////
    
    if(intro == 1) { 
        
        
        
       if (backgroundReset == 1) { //Background reset call
            drawBackground();
        }
        
        
       // Call voids
        drawGrid(); 
        rtVal();
        sensorStatus();
        
        
        
        if (millis() - interval2 > 10000) { //Climb rate calculation & logging of former altitude
            interval2 = millis();
            climbR= (currentAltitudeRaw - formerAltitude) / 10;
            delay(1);
            formerAltitude = currentAltitudeRaw;
        }
        
        
        if (millis() - interval > 500) { //Main update of graph every half second
            interval = millis();
            
            
            
            if (mousePressed && (mouseY > 0) && (mouseY < 100) && (mouseX > 1625) && (mouseX < 1700)) { // Reset button of the graph
                xPos = 0; //Reset graph to the start
               preHeat = temp;
               prePosx = 0;
                background(0);   
                backgroundReset = 1;
            }
            
            
            
            if (preHeat == 0) { //Initiate Previous values as the current one at startup
               prehum = hum;
                preHeat = temp;
               prePress = press;
               preAlt = currentAltitude;
                
               xPos = 0;
        } else { //Logs previous values for graph plotting
                
                stroke(255, 255, 255);
                line(prePosx, preHeat, xPos - 1, yPos);
                line(prePosx, prePress, xPos - 1, press);
                if (currentAltitudeRaw > 0) {line(prePosx + 500, preAlt, xPos + 499 , currentAltitude);}
                line(prePosx+ 500, prehum, xPos + 499, hum);
                
                
                
                delay(10);
               yPos = temp;
               prehum = hum;
               prePress = press;
                prePosx = xPos;
                preHeat = temp;
               preAlt = currentAltitude;
            }
            
            if (xPos>= 500) { //Pulls back graphs to x = 0 when it reaches the end of the graph
                xPos = 0;
               preHeat = temp;
               prePosx = 0;
                background(0);   
                
                drawBackground();
                
                
                backgroundReset = 1;
        } else { //Makes the graph go forward every half a second
                
                xPos = xPos+ 3;
                
        }
        }
}
}




public void serialEvent(Serial myPort) {
    
    try {                                        //Initiate & Breaks String from COM port into separate values
        String inString = myPort.readString();
        String[] stringData = split(inString, ',');
        float[] values = PApplet.parseFloat(stringData);
        
        
        if (inString != null) { 
            
         
            currentAltitudeRaw = 44330 * (1.0f - pow(values[1] / intStroke, 0.1903f)); //Pressure Altitude calculations
            
           temp = map(values[0], 50, 0, 0, 500);           //Mapping of values into plot points
            press = map(values[1], 900, 1020, 500, 1000);
            hum = map(values[2], 30, 120, 1000, 500);
            currentAltitude = map(currentAltitudeRaw, 0, 1000, 500, 0);
            
            tempRaw = values[0]; //Grabs Raw value from Serial port
            humRaw =values[2];
            
            
            myPort.write('s');
            
            
    }
}
    
    catch(RuntimeException e) {
        e.printStackTrace();
}
}


public void keyPressed() { //Logs keypresses 
    
    if (keyCode != ENTER && keyCode != BACKSPACE) input += key;

    
}
public void drawBackground(){
    
    textSize(20); //Text in Graph
    fill(0xFFFFFFFF);
    textAlign(CENTER);
    text("Temperature(°C)", 250, 50);
    text("Pressure Altitude (m)", 750, 50);
    text("Pressure (hPa)", 250, 550);
    text("Humidity (%)", 750, 550);
    
    textAlign(LEFT); //Text in RT & Status
    text("BMP280", 1020, 25);
    text("HTU21D", 1120, 25);
    text("Temp.", 1020, 100);
    text("Speed", 1320, 100);
    text("Altitude", 1220, 100);
    text("Humd.", 1120, 100);
    text("Climb R.", 1420, 100);
    
      
    text("°C", 1055, 120); //Units in RT
    text("m/s", 1365, 120); 
    text("m", 1265, 120);
    text("%", 1165, 120);
    text("m/s", 1465, 120);
    
    textSize(15); //Values in Graph
    text("50", 3, 12);
    text("0", 3, 495);
    text("900", 3, 512);
    text("1020", 3, 995);
    text("1000", 503, 12);
    text("0", 503, 495);
    text("20", 503, 995);
    text("150", 503, 512);


    textSize(15); //Sea-Level Pressure
    text("SL :", 228, 565);
    text(intStroke, 250, 565);
    
    image(img, 1625, 0, 70, 70);

    backgroundReset= 0; // Runs the code only once
}

public void drawGrid () {
    fill(0xFFFFFFFF); // Lines in the graph
    line(0, 1000, 0, 0);
    line(0, 500, 1000, 500);
    line(500, 1000, 500, 0);
    line(1000, 0, 1000, 1000);
    line(1000, 70, 1700, 70);
    line(1000, 140, 1700, 140);
}
public void sensorStatus() {


    
    if (hum < 0) { //HTU21D Status

      int i = 0;
      while (i == 0){
      fill(0xFF000000);
      noStroke();
      rect(1150, 45, 100, 40);
      textSize(20);
      textAlign(LEFT);
      fill(0xFFFF0000);
      text("Offline", 1120, 50);
      i++;
      }

       
    } else {

      int i = 0;
      while (i == 0){
      fill(0xFF000000);
      noStroke();
      rect(1150, 45, 100, 40);
      textSize(20);
      textAlign(LEFT);
      fill(0xFF00FF00);
      text("Online", 1120, 50);
      i++;
      }
    }

    
    if (temp < 0) { //BMP280 Status
      
      int i = 0;
      while (i == 0){
      fill(0xFF000000);
      noStroke();
      rect(1070, 45, 100, 40);
      textSize(20);
      textAlign(LEFT);
      fill(0xFFFF0000);
      text("Offline", 1020, 50);
      i++;
      }
      
    } else {

      int i = 0; 
      while (i == 0){
      fill(0xFF000000);
      noStroke();
      rect(1070, 45, 100, 40);
      textSize(20);
      textAlign(LEFT);
      fill(0xFF00FF00);
      text("Online", 1020, 50);
      i++;
      }
    }


    if (intStroke > 1050 || intStroke < 1000) { //Press alt check

      int i = 0;
      while (i == 1){
      fill(0xFF000000);
      noStroke();
      rect(720, 245, 350, 50);
      textSize(20);
      textAlign(CENTER);
      fill(0xFFFF0000);
      text("Sea-Level Pressure out of bounds!", 750, 250);
      text("Please restart software", 750, 270);
      
      i++;
      }
      
    }

    if (currentAltitudeRaw > 100) { //Allign m if altitude > 100
      allign = 1215;
    } else {
      allign = 1220;
    }
}
public void rtVal( ){

    
    fill(0xFF000000); //Black rectangles for text updates
    noStroke();
    rect(1037, 115, 35, 20);
    rect(1142, 115, 45, 20);
    rect(1237, 115, 55, 20);
    rect(1337, 115, 35, 20);
    rect(1437, 115, 35, 20);       
    fill(0xFFFFFFFF);
    
    textSize(20); //Values in real time
    textAlign(LEFT);
    text(nf(tempRaw, 0, 1), 1020, 120);  
    text(nf(currentAltitudeRaw, 0, 1), 1320, 120); 
    text(nf(currentAltitudeRaw, 0, 1), allign, 120);
    text(nf(humRaw, 0, 1), 1120, 120);
    text(nf(climbR, 0, 1), 1420, 120); 
}


  public void settings() { size(1700, 1000); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "Main" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
